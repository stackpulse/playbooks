apiVersion: stackpulse.io/v1
kind: Playbook
metadata:
  name: create-incident-war-room
parameters:
  - name: "notificationChannel"
    type: var
    description: "The name of the channel or user you would like to notify about the incident (channel should start with #)."
  - name: "invitees"
    type: var
    description: "The emails of the users that will be invited to the channel (by default, only the incident reporter)."
    default: '{{ $.event.Reporter }}'
  - name: "eventID"
    type: var
    description: "The received event ID."
    default: '{{ $.event.ID }}'
  - name: "eventName"
    type: var
    description: "The received event Name."
    default: '{{ $.event.Name }}'
  - name: "eventDescription"
    type: var
    description: "The received event Description."
    default: '{{ $.event.Description }}'
  - name: "warRoomChannelName"
    type: var
    description: "The War Room Slack channel name to be attached to the incident."    
  - name: "slackIntegrationName"
    type: integration
    description: "Slack integration."
    options:
      integration_type: slack
steps:
# Creates war-room channel
- name: us-docker.pkg.dev/stackpulse/public/slack/channel/create
  id: slack_create_war_room_channel
  env:
    CHANNEL_NAME: "{{ $.params.eventID }} {{ $.params.eventName }}"
    PURPOSE: '{{ $.params.eventDescription }}'
    TOPIC: "StackPulse War Room Channel for Incident {{ $.params.eventName }} ({{ $.params.eventID }})"
    USERS: '{{ $.params.invitees }}'
  envFrom:
    integrationRef: '{{ $.params.slackIntegrationName }}'

# Attach war-room channel to StackPulse incident
- name: us-docker.pkg.dev/stackpulse/public/stackpulse/incident/update
  id: attach_war_room_channel_to_incident
  env:
    INCIDENT_ID: '{{ $.params.eventID }}'
    SLACK_WAR_ROOM_NAME: '{{ $.params.warRoomChannelName }}'
  envFrom:
    integrationRef: '{{ $.params.slackIntegrationName }}'

# Send message in notification channel about creation of war-room
- name: us-docker.pkg.dev/stackpulse/public/slack/message/dynamic
  id: slack_alert_notification_channel
  env:
    SP_REDIRECT_URL: https://app.stackpulse.io/execution/{{ $.execution.id }}
    MESSAGE_TEXT: "@channel, *StackPulse created an incident*\nhttps://app.stackpulse.io/incident/{{ $.params.eventID }}\n*A War Room was created*\n#{{ $.params.warRoomChannelName }}"
    RECIPIENTS: "{{ $.params.notificationChannel }}"
  envFrom:
    integrationRef: '{{ $.params.slackIntegrationName }}'

# Send message in war-room with incident details
- name: us-docker.pkg.dev/stackpulse/public/slack/message/dynamic
  id: slack_alert_war_room_channel
  env:
    SP_REDIRECT_URL: https://app.stackpulse.io/execution/{{ $.execution.id }}
    MESSAGE_TEXT: "@channel, *StackPulse created an incident*\nhttps://app.stackpulse.io/incident/{{ $.params.eventID }}\n*A War Room was created*\n#{{ $.params.warRoomChannelName }}"
    RECIPIENTS: "#{{ $.params.warRoomChannelName }}"
  envFrom:
    integrationRef: '{{ $.params.slackIntegrationName }}'